<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="制作一个简单版类吸血鬼幸存者游戏，这一系列教程第1个项目的笔记">
<title>【从零开始的C&#43;&#43;游戏开发】提瓦特幸存者</title>

<link rel='canonical' href='https://nullshowjl.github.io/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/'>

<link rel="stylesheet" href="/scss/style.min.3b99540141ea6d96ea57a2341f6a138640e2de77d5547ecfa3a88330ad283de6.css"><meta property='og:title' content="【从零开始的C++游戏开发】提瓦特幸存者">
<meta property='og:description' content="制作一个简单版类吸血鬼幸存者游戏，这一系列教程第1个项目的笔记">
<meta property='og:url' content='https://nullshowjl.github.io/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/'>
<meta property='og:site_name' content='Nullshow的技术博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Game Dev' /><meta property='article:tag' content='C&#43;&#43;' /><meta property='article:tag' content='EasyX' /><meta property='article:published_time' content='2025-10-08T10:47:30&#43;02:00'/><meta property='article:modified_time' content='2025-10-16T11:10:15&#43;02:00'/><meta property='og:image' content='https://nullshowjl.github.io/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/cover.webp' />
<meta name="twitter:title" content="【从零开始的C++游戏开发】提瓦特幸存者">
<meta name="twitter:description" content="制作一个简单版类吸血鬼幸存者游戏，这一系列教程第1个项目的笔记"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://nullshowjl.github.io/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/cover.webp' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
        
        <figure class="site-avatar">
            <a href="/">
                
                

                
                
                <img src="/img/avatar_hu_7adbda40a4f6f680.png" width="300"
                     height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                
            </a>
            
            <span class="emoji">✍️</span>
            
        </figure>
        
        

        <div class="site-meta">
            <h1 class="site-name"><a href="/">Nullshow的技术博客</a></h1>
            <h2 class="site-description">分享和记录我在开发和学习中的笔记、经验和感悟~</h2>
        </div>
    </header><ol class="menu-social">
        
        
        
        <li>
            <a href='https://gitee.com/nullshow'
                target="_blank" 
                title="Gitee" 
               rel="me">
                
                
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-hexagon-letter-g" class="icon-tabler-hexagon-letter-g"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.875 6.27a2.225 2.225 0 0 1 1.125 1.948v7.284c0 .809 -.443 1.555 -1.158 1.948l-6.75 4.27a2.269 2.269 0 0 1 -2.184 0l-6.75 -4.27a2.225 2.225 0 0 1 -1.158 -1.948v-7.285c0 -.809 .443 -1.554 1.158 -1.947l6.75 -3.98a2.33 2.33 0 0 1 2.25 0l6.75 3.98h-.033z" /><path d="M14 8h-2a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2v-4h-1" /></svg>
                
            </a>
        </li>
        
        
        
        <li>
            <a href='https://github.com/NullshowJL'
                target="_blank" 
                title="GitHub" 
               rel="me">
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-brand-github">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                
            </a>
        </li>
        
        
        
        
        
        <li>
            <a href='/index.xml'
                target="_blank" 
                title="RSS" 
               rel="me">
                
                
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-rss" class="icon-tabler-brand-rss"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M4 4a16 16 0 0 1 16 16" /><path d="M4 11a9 9 0 0 1 9 9" /></svg>
                
            </a>
        </li>
        
    </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-home">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/portfolio/' >
                
                
                
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-device-gamepad-2" class="icon-tabler-device-gamepad"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5h3.5a5 5 0 0 1 0 10h-5.5l-4.015 4.227a2.3 2.3 0 0 1 -3.923 -2.035l1.634 -8.173a5 5 0 0 1 4.904 -4.019h3.4z" /><path d="M14 15l4.07 4.284a2.3 2.3 0 0 0 3.925 -2.023l-1.6 -8.232" /><path d="M8 9v2" /><path d="M7 10h2" /><path d="M14 10h2" /></svg>
                
                <span>作品集</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-user">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%AD%A6%E4%B9%A0%E5%8E%86%E7%A8%8B/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-trekking" class="icon-tabler-journey"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11 4a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /><path d="M7 21l2 -4" /><path d="M13 21v-4l-3 -3l1 -6l3 4l3 2" /><path d="M10 14l-1.827 -1.218a2 2 0 0 1 -.831 -2.15l.28 -1.117a2 2 0 0 1 1.939 -1.515h1.439l4 1l3 -2" /><path d="M17 12v9" /><path d="M16 20h2" /></svg>
                
                <span>学习历程</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97/' >
                
                
                
                <!--
unicode: "fea7"
version: "3.1"
-->
<svg
  xmlns="http://www.w3.org/2000/svg"
  width="24"
  height="24"
  viewBox="0 0 24 24"
  fill="none"
  stroke="#000000"
  stroke-width="0.5"
  stroke-linecap="round"
  stroke-linejoin="round"
 class="icon-tabler-logs">
  <path d="M4 12h.01" />
  <path d="M4 6h.01" />
  <path d="M4 18h.01" />
  <path d="M8 18h2" />
  <path d="M8 12h2" />
  <path d="M8 6h2" />
  <path d="M14 6h6" />
  <path d="M14 12h6" />
  <path d="M14 18h6" />
</svg>

                
                <span>更新日志</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-archives">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-search">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-link">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                
                <li id="i18n-switch">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-language">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                        <option value="https://nullshowjl.github.io/en/" >English</option>
                        
                        <option value="https://nullshowjl.github.io/"  selected>中文</option>
                        
                    </select>
                </li>
                
                

                
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-toggle-left">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-toggle-right">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-hash">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#概览">概览</a></li>
    <li><a href="#核心玩法">核心玩法</a></li>
    <li><a href="#项目主体开发">项目主体开发</a>
      <ol>
        <li><a href="#设计思路">设计思路</a>
          <ol>
            <li><a href="#游戏主框架的设计">游戏主框架的设计</a></li>
            <li><a href="#各个对象类的设计">各个对象/类的设计</a></li>
          </ol>
        </li>
        <li><a href="#开发流程">开发流程</a></li>
        <li><a href="#关键步骤和解决思路">关键步骤和解决思路</a>
          <ol>
            <li><a href="#图片的加载和渲染">图片的加载和渲染</a></li>
            <li><a href="#实现动画及渲染">实现动画及渲染</a></li>
            <li><a href="#实现角色移动">实现角色移动</a></li>
            <li><a href="#各个类的封装">各个类的封装</a></li>
            <li><a href="#敌人类的实现细节">敌人类的实现细节</a></li>
            <li><a href="#2d碰撞检测的实现">2D碰撞检测的实现</a></li>
            <li><a href="#子弹的更新和视觉效果的提升">子弹的更新和视觉效果的提升</a></li>
            <li><a href="#删除被击杀的敌人">删除被击杀的敌人</a></li>
            <li><a href="#播放音效">播放音效</a></li>
            <li><a href="#提升性能使用享元模式优化资源加载">提升性能：使用享元模式优化资源加载</a></li>
            <li><a href="#按钮类的设计">按钮类的设计</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#番外篇角色动画特效和像素缓冲区">番外篇：角色动画特效和像素缓冲区</a>
      <ol>
        <li><a href="#色彩知识补充">色彩知识补充</a></li>
        <li><a href="#图像翻转效果的实现">图像翻转效果的实现</a></li>
        <li><a href="#获取每一个像素颜色的rgb分量">获取每一个像素颜色的RGB分量</a></li>
        <li><a href="#图片闪烁效果的实现">图片闪烁效果的实现</a></li>
        <li><a href="#冻结效果的实现">冻结效果的实现</a>
          <ol>
            <li><a href="#alpha混合的原理">Alpha混合的原理</a></li>
            <li><a href="#具体实现">具体实现</a></li>
            <li><a href="#优化给冰冻状态增加高亮效果">优化：给冰冻状态增加高亮效果</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#项目主体部分的完整源码">项目主体部分的完整源码</a></li>
    <li><a href="#复盘和总结">复盘和总结</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/">
                <img src="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/cover_hu_2972b62f5c597f14.webp"
                        srcset="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/cover_hu_2972b62f5c597f14.webp 800w, /p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/cover_hu_2408b0e7d95b54b8.webp 1600w"
                        width="800" 
                        height="240" 
                        loading="lazy"
                        alt="Featured image of post 【从零开始的C&#43;&#43;游戏开发】提瓦特幸存者" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/study-notes/" style="background-color: #2a9d8f; color: #fff;">
                Study Notes
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%8F%90%E7%93%A6%E7%89%B9%E5%B9%B8%E5%AD%98%E8%80%85/">【从零开始的C&#43;&#43;游戏开发】提瓦特幸存者</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            制作一个简单版类吸血鬼幸存者游戏，这一系列教程第1个项目的笔记
        </h3>
        
    </div>

    
    
    
    
<footer class="article-time">
    
    <div>
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-date">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
        <time class="article-time--published">Oct 08, 2025</time>
    </div>
    

    
    <div>
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-clock">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--reading">
            阅读时长: 27 分钟
        </time>
    </div>
    

    
    <div id="viewCount">
        <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye" class="icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
        <time class="article-time--reading">
            
            <span id="vercount_value_page_pv">loading... </span> views
        </time>
    </div>

</footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><strong>目录</strong></p>
<ul>
<li><a class="link" href="#%e6%a6%82%e8%a7%88" >概览</a></li>
<li><a class="link" href="#%e6%a0%b8%e5%bf%83%e7%8e%a9%e6%b3%95" >核心玩法</a></li>
<li><a class="link" href="#%e9%a1%b9%e7%9b%ae%e4%b8%bb%e4%bd%93%e5%bc%80%e5%8f%91" >项目主体开发</a></li>
<li><a class="link" href="#%e7%95%aa%e5%a4%96%e7%af%87%e8%a7%92%e8%89%b2%e5%8a%a8%e7%94%bb%e7%89%b9%e6%95%88%e5%92%8c%e5%83%8f%e7%b4%a0%e7%bc%93%e5%86%b2%e5%8c%ba" >番外篇：角色动画特效和像素缓冲区</a></li>
<li><a class="link" href="#%e9%a1%b9%e7%9b%ae%e4%b8%bb%e4%bd%93%e9%83%a8%e5%88%86%e7%9a%84%e5%ae%8c%e6%95%b4%e6%ba%90%e7%a0%81" >项目主体部分的完整源码</a></li>
<li><a class="link" href="#%e5%a4%8d%e7%9b%98%e5%92%8c%e6%80%bb%e7%bb%93" >复盘和总结</a></li>
</ul>
<h2 id="概览">概览
</h2><p><strong>技术栈</strong>：C++ + EasyX</p>
<p><strong>项目目标</strong>：设计游戏的动画框架，接入键盘的按键操作，提供更具交互性的玩法。在数据和逻辑层面，实现简单的2D平面内的碰撞检查；实现敌人的随机生成和索敌跟踪逻辑。添加音乐和音效，丰富游戏的完成度。添加主菜单界面。使用享元模式来优化程序性能。</p>
<p><strong>课程来源</strong>：<a class="link" href="https://www.bilibili.com/video/BV1eM4m1S74K/?share_source=copy_web"  target="_blank" rel="noopener"
    >B站-Voidmatrix</a></p>
<h2 id="核心玩法">核心玩法
</h2><p>玩家点击 <strong>开始</strong> 按钮进入游戏，使用 <strong>上 下 左 右</strong> 按键控制角色移动。在玩家角色的周围会有一圈子弹，野猪敌人会从屏幕外源源不断地涌向玩家。当子弹碰到敌人后，会击杀敌人并增加游戏得分。当敌人碰触到玩家角色时，游戏结束。</p>
<h2 id="项目主体开发">项目主体开发
</h2><h3 id="设计思路">设计思路
</h3><h4 id="游戏主框架的设计">游戏主框架的设计
</h4><p>创建窗口、创建游戏主循环和稳定帧率，这个写法基本是游戏开发框架的固定格式，因为在 <strong>系列笔记第0集 基础</strong> 中有详细的解释，此处就不再赘述。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//========= 初始化数据 ==========
</span></span></span><span class="line"><span class="cl">	<span class="n">initgraph</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">FPS</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">ExMessage</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">BeginBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">is_running</span><span class="p">)</span>	<span class="c1">// 游戏主循环
</span></span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//========= 处理输入 =========
</span></span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="n">peekmessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//======== 处理更新 =========
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cleardevice</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//======== 处理渲染 =========
</span></span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">FlushBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//========= 稳定帧率 =========
</span></span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">delta_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">delta_time</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span> <span class="o">-</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">EndBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="各个对象类的设计">各个对象/类的设计
</h4><p>本项目并没有使用多态来抽象出更上层的对象。基本按照一个对象设计一个类的思路进行。为了更加符合初学者的直觉和理解，将所有的代码放在了<code>main.cpp</code> 中，使用了大量的全局变量实现项目。</p>
<ul>
<li>玩家类</li>
<li>子弹类（玩家周围的一圈子弹）</li>
<li>敌人类</li>
<li>动画类和图集类（实现和优化动画效果）</li>
<li>按钮基类
<ul>
<li>开始游戏按钮</li>
<li>退出游戏按钮</li>
</ul>
</li>
</ul>
<h3 id="开发流程">开发流程
</h3><ul>
<li>
<p>游戏框架的设计</p>
</li>
<li>
<p>图片的加载和渲染</p>
<ul>
<li>解决思路：使用EasyX的库函数：loadimage, putimage</li>
<li>问题：png图片会产生黑边
<ul>
<li>解决思路：自己在putimage的基础上重载一个含有透明通道的函数</li>
<li>注意：要包含对应的库 <code>pragma comment(lib, &quot;MSIMG32.LIB&quot;)</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>动画的实现</p>
<ul>
<li>问题1：如何让图片动起来？
<ul>
<li>解决思路：计数器 ===&gt; 优化：计时器</li>
</ul>
</li>
<li>问题2：动画的实现出现大量重复代码
<ul>
<li>解决思路：封装Animation类</li>
</ul>
</li>
</ul>
</li>
<li>
<p>角色移动的实现</p>
<ul>
<li>问题1：玩家移动时出现“卡顿感”
<ul>
<li>解决思路：使用bool变量来标识按键的按下和抬起，间接控制玩家的运动</li>
</ul>
</li>
<li>问题2：玩家在斜线运动的速度快于水平/竖直方向
<ul>
<li>解决思路：使用单位向量统一各个方向的速度</li>
</ul>
</li>
</ul>
</li>
<li>
<p>问题：在试图实现敌人动画时发现和玩家的数据会一起混在Animation类中</p>
<ul>
<li>解决思路：使用面向对象的思想，创建各类管理各自的数据和逻辑</li>
</ul>
</li>
<li>
<p>Player类的实现</p>
</li>
<li>
<p>Bullet类的实现</p>
</li>
<li>
<p>Enemy类的实现</p>
<ul>
<li>问题1：敌人刷新机制的实现
<ul>
<li>解决思路：将敌人随机生成在地图外的一条边上</li>
</ul>
</li>
<li>注意点：函数中如果需要传入别的类的对象，要用引用传入，如果不会改变这个参数，就加上const</li>
<li>问题2：敌人自动寻路机制的实现
<ul>
<li>解决思路：玩家位置与敌人位置之差，计算其单位向量，就是敌人的移动方向</li>
</ul>
</li>
</ul>
</li>
<li>
<p>2D碰撞检测的实现</p>
<ul>
<li>问题1：敌人和子弹的碰撞
<ul>
<li>解决思路：将敌人看作一个矩形处理，而子弹则按照点来处理</li>
</ul>
</li>
<li>问题2：玩家和敌人的碰撞
<ul>
<li>解决思路：将敌人的中心点作为碰撞点，与玩家的矩形进行碰撞检测</li>
</ul>
</li>
</ul>
</li>
<li>
<p>子弹的更新、视觉效果的提升</p>
<ul>
<li>问题：让子弹的运动更加炫酷
<ul>
<li>解决思路：给子弹一个切向速度、一个径向速度</li>
</ul>
</li>
</ul>
</li>
<li>
<p>删除被击杀的敌人</p>
<ul>
<li>解决思路：先用 <code>swap</code> 将待删除的敌人移到vector末尾，再使用 <code>pop_back</code>，最后使用 <code>delete</code> 释放内存。这是一种 <strong>在元素次序无关</strong> 时性能较好的删除方法。</li>
</ul>
</li>
<li>
<p>添加和绘制玩家得分</p>
</li>
<li>
<p>添加音效</p>
<ul>
<li>解决思路：使用Windows的库函数：mciSendString</li>
<li>注意：要包含对应的库 <code>pragma comment(lib, &quot;Winmm.lib&quot;)</code></li>
</ul>
</li>
<li>
<p>优化：性能提升</p>
<ul>
<li>解决思路：使用 <strong>享元模式</strong> 优化资源加载</li>
<li>注意：不能在Animation中释放其持有的Atlas，因为它是共享的，所以只能由更上层的代码控制</li>
</ul>
</li>
<li>
<p>添加主菜单UI、按钮类的设计</p>
</li>
</ul>
<h3 id="关键步骤和解决思路">关键步骤和解决思路
</h3><h4 id="图片的加载和渲染">图片的加载和渲染
</h4><h5 id="实现读取加载图片">实现读取/加载图片
</h5><p>阅读文档，可以看到EasyX使用 <code>loadimage</code> 这个函数来加载图片，这个函数有一个重载，此处我们直接使用较简单的 <strong>从图片文件中获取图像</strong> 这一个：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 从图片文件获取图像(bmp/gif/jpg/png/tif/emf/wmf/ico)
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">loadimage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span><span class="o">*</span> <span class="n">pDstImg</span><span class="p">,</span>			<span class="c1">// 保存图像的 IMAGE 对象指针
</span></span></span><span class="line"><span class="cl">	<span class="n">LPCTSTR</span> <span class="n">pImgFile</span><span class="p">,</span>		<span class="c1">// 图片文件名
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">nWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>			<span class="c1">// 图片的拉伸宽度
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">nHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="c1">// 图片的拉伸高度
</span></span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bResize</span> <span class="o">=</span> <span class="nb">false</span>	<span class="c1">// 是否调整 IMAGE 的大小以适应图片
</span></span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此处需要注意的是，第一个参数是一个图片的指针对象。我们不直接将图片加载到窗口中，而是先保存到变量里，然后在后续绘制中使用，所以要传入要给非空指针；第二个参数是图片的路径字符串；后三个参数均提供了默认值，用来设置图片的缩放属性，此项目中用不到，所以暂时忽略。那么，要加载程序目录下的图片 <code>text.jpg</code> , 可以这样表示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;test.jpg&#34;</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="实现渲染图片">实现渲染图片
</h5><p>同样阅读文档，我们发现可以使用 <code>putimage</code> 这个函数来绘制图片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 绘制图像
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">putimage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">dstX</span><span class="p">,</span>				<span class="c1">// 绘制位置的 x 坐标
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">dstY</span><span class="p">,</span>				<span class="c1">// 绘制位置的 y 坐标
</span></span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="o">*</span><span class="n">pSrcImg</span><span class="p">,</span>			<span class="c1">// 要绘制的 IMAGE 对象指针
</span></span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwRop</span> <span class="o">=</span> <span class="n">SRCCOPY</span>	<span class="c1">// 三元光栅操作码
</span></span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，第一二个参数是图片绘制在世界坐标中的位置。最后一个参数 <strong>三元光栅操作码</strong> 我们在这个项目中也忽略不计。那么如果要绘制刚刚加载的图片，这样我们可以写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 加载图片
</span></span></span><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;test.jpg&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 绘制图片
</span></span></span><span class="line"><span class="cl"><span class="n">putimage</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果这张图片的像素是 <code>300 * 300</code> ，那么这张图片在游戏界面中的坐标是这样的：</p>
<img src="teyvat1.webp" alt="" style="zoom:33%;" />
<p>需要注意的是，我们需要自己封装带有透明通道的 <code>putimage</code>函数，来解决显示的 <code>png</code> 图片带有黑框的问题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma comment(lib, &#34;MSIMG32.LIB&#34;) 
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">putimage_alpha</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">IMAGE</span><span class="o">*</span> <span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">AlphaBlend</span><span class="p">(</span><span class="n">GetImageHDC</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">GetImageHDC</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">{</span> <span class="n">AC_SRC_OVER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">AC_SRC_ALPHA</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在函数之前（最好放在文件的开始处，要链接相关的库 <code>#pragma comment(lib, &quot;MSIMG32.LIB&quot;) </code> 。</p>
<h4 id="实现动画及渲染">实现动画及渲染
</h4><h5 id="如何让画面动起来">如何让画面动起来？
</h5><p>游戏中角色动画的常见实现可以笼统地分为两类：<strong>序列帧动画</strong> 和 <strong>关键帧动画</strong> 。</p>
<p><strong>序列帧动画</strong> ：通常由一组图片素材构成，在程序中随着时间推移，我们不断地切换显示这一序列的图片，借助视觉暂留效应，产生动画效果。</p>
<p><strong>关键帧动画</strong> 如骨骼动画等，因为涉及更复杂的图形学技术，此处暂不讨论。</p>
<p>注意，我们不能通过调用 <code>Sleep()</code> 函数来解决这个问题。因为当调用 <code>Sleep()</code> 函数时，程序会卡在那里，等待一定时间，这是一个“阻塞式”的行为，而在我们的游戏框架设计中，所有的画面渲染等操作，都应该式在一次又一次的循环中进行，每次循环的时间都控制在 <code>1/60秒（FPS）</code> 内。也就是说，我们切换动画轮播的任务，应该分摊在多帧之间进行，而不是在一次循环内全部结束。此处涉及到一个游戏编程中的核心思想：<strong>主循环内应尽量避免阻塞式的行为或者过于繁重且耗时过长的任务</strong>。</p>
<p>为了确保动画序列帧可以在间隔固定的时间进行切换，采用了计时器的思路来做这样的一个计数器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">idx_current_anim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// 1. 存储当前动画帧的帧索引
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">PLAYER_ANIM_NUM</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="c1">// 动画帧总数量
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.....</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">is_running</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">peekmessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  	    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// 2. 记录当前动画帧一共播放了几个游戏帧
</span></span></span><span class="line"><span class="cl">                                <span class="c1">// 用static修饰可以确保计数器只有在第一个游戏帧时被初始化为0
</span></span></span><span class="line"><span class="cl">        <span class="c1">// 每5个游戏帧切换一个动画帧
</span></span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx_current_anim</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="err">（</span><span class="n">idx_current_anim</span> <span class="o">%</span> <span class="n">PLAYER_ANIM_NUM</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx_current_anim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画的渲染本质就是将IMAGE数组中的图片依次绘制即可。先加载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">PLAYER_ANIM_NUM</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="c1">// 动画帧总数量
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img_player_left</span><span class="p">[</span><span class="n">PLAYER_ANIM_NUM</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img_player_right</span><span class="p">[</span><span class="n">PLAYER_ANIM_NUM</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">load_animation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PLAYER_ANIM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">path</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;img/player_left_&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_wstring</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="sa">L</span><span class="s">&#34;.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PLAYER_ANIM_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">path</span> <span class="o">=</span> <span class="sa">L</span><span class="s">&#34;img/player_right_&#34;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_wstring</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="sa">L</span><span class="s">&#34;.png&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_right</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在 <code>main</code> 中绘制这一系列动画图片的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">is_running</span><span class="p">)</span>	<span class="c1">// 游戏主循环
</span></span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//========= 处理输入 =========
</span></span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="n">peekmessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//======== 处理更新 =========
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cleardevice</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//======== 处理渲染 =========
</span></span></span><span class="line"><span class="cl">		<span class="n">putimage_alpha</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">idx_current_anim</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="n">FlushBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="p">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="将动画的实现封装成动画类">将动画的实现封装成动画类
</h5><p>数据结构层面，用vector来存储动画所需图片的指针<code>vector&lt;IMAGE*&gt; </code>。在构造函数中，需要加载动画所需的图片资源同时为其分配了内存空间，那么对应的，需要在析构函数中释放图片资源被释放内存空间.</p>
<p>在播放动画时，参数中除了需要知道动画播放的位置外，还增加了一个参数<code>int delta</code>用来表示距离上一次调用<code>Play</code>函数过去了多久时间，这是将“计数器”概念转为了“计时器”。之所以优化为这种设计，是因为一个动画的播放速度也就是 <strong>帧间隔</strong>，应该是与实际时间有关的，而不是与游戏的帧率有关，我们希望的是无论游戏帧的频率有多快，动画的播放速度是一致的，而不是画面刷新越快，动画播放越快。所以使用与实际时间有关的定时器，会比每一下调用都累加一次的计数器更能满足这种需求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Animation</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="p">(</span><span class="n">LPCTSTR</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>	<span class="c1">// 加载动画帧图片资源
</span></span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">interval_ms</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">TCHAR</span> <span class="n">path_file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_sprintf_s</span><span class="p">(</span><span class="n">path_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">IMAGE</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IMAGE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">loadimage</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">path_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">frame_list</span><span class="p">.</span><span class="n">push_bacl</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">Play</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>	<span class="c1">// 播放动画 
</span></span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">timer</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&gt;=</span> <span class="n">interval_ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 绘制每一帧图片
</span></span></span><span class="line"><span class="cl">        <span class="n">pitimage_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">idx_frame</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Animation</span><span class="p">()</span>	<span class="c1">// 释放资源
</span></span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">vector</span><span class="o">&lt;</span><span class="n">IMAGE</span><span class="o">*&gt;</span> <span class="n">frame_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">interval_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// 帧间隔
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">idx_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="实现角色移动">实现角色移动
</h4><p>如果我们直接在按下按键时，用在不同坐标轴上累加位移的方式来控制玩家，会出现手感上的“卡顿感”。这是因为 <code>WM_KEYDOWN</code> 消息的产生是与我们的主循环 <strong>异步进行</strong> 的，且触发的频率与操作系统和硬件设备相关，这就导致在有些游戏帧中事件处理部分对多个<code>WM_KEYDOWN</code>消息进行了处理，而在其余游戏帧中<code>WM_KEYDOWN</code>消息较少或没有，这就导致角色在某些游戏帧中前进的距离较远/近一些，在宏观上展现为移动过程中的卡顿感。另外，当我们按下方向键时，会首先有一个 <code>WM_KEYDOWN</code> 消息进入消息事件队列中，随后，当我们保持按键按下状态一段时间后，才会有接连不断的 <code>WM_KEYDOWN</code> 消息被触发。</p>
<p>所以，要确保角色在每一个游戏帧中都连贯地移动相同的距离，从玩家的角色触发，就是：当玩家按下按键时，<code>WM_KEYDOWN</code> 消息触发，角色开始移动；当玩家抬起按键时，<code>WM_KEYUP</code> 消息触发，角色结束移动。所以使用相应的四个布尔变量来代表玩家的移动方向，我们通过改变按键的按下和抬起来改变这四个布尔变量的值，然后根据布尔变量的值来实现玩家在坐标轴上的位移：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ProcessEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">ExMessage</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_KEYDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">vkcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_DOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_down</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_LEFT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_left</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_RIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_right</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_KEYUP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">vkcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_DOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_down</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_LEFT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">VK_RIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">is_moving_right</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>		
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Move</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_moving_up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_moving_down</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_moving_left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_moving_right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>另外，为了避免玩家在斜角运动时位移更多的问题，需要使其在该速度方向的向量是单位向量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">dir_x</span> <span class="o">=</span> <span class="n">is_move_right</span> <span class="o">-</span> <span class="n">is_move_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">dir_y</span> <span class="o">=</span> <span class="n">is_move_down</span> <span class="o">-</span> <span class="n">is_move_up</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">len_dir</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dir_x</span> <span class="o">*</span> <span class="n">dir_x</span> <span class="o">+</span> <span class="n">dir_y</span> <span class="o">+</span> <span class="n">dir_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">len_dir</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">normalized_x</span> <span class="o">=</span> <span class="n">dir_x</span> <span class="o">/</span> <span class="n">len_dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">normalized_y</span> <span class="o">=</span> <span class="n">dir_y</span> <span class="o">/</span> <span class="n">len_dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">player_pos</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">PLAYER_SPEED</span> <span class="o">*</span> <span class="n">normalized_x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">player_pos</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">PLAYER_SPEED</span> <span class="o">*</span> <span class="n">normalized_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="各个类的封装">各个类的封装
</h4><p>为了避免各个数据糅杂散落在项目的各处，将每个对象相关的逻辑和数据封装到各组的类中。以玩家类为例，大致的类的设计：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Player</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Player</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 初始化资源：动画资源、图片资源等
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Player</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 释放资源
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">ProcessEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">ExMessage</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 玩家的输入逻辑
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">Move</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理玩家移动
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">Draw</span><span class="p">(</span><span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 绘制玩家
</span></span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="敌人类的实现细节">敌人类的实现细节
</h4><h5 id="敌人的随机生成机制">敌人的随机生成机制
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 敌人生成的边界
</span></span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="k">class</span> <span class="nc">SpawnEdge</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">Down</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">Left</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">Right</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 将敌人生成在四条边界中随机的一条上
</span></span></span><span class="line"><span class="cl"><span class="n">SpawnEdge</span> <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpawnEdge</span><span class="p">)(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 具体的随机坐标值
</span></span></span><span class="line"><span class="cl"><span class="k">switch</span> <span class="p">(</span><span class="n">edge</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Up</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Down</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Right</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rand</span> <span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="敌人的寻路机制">敌人的寻路机制
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Move</span><span class="p">(</span><span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">POINT</span><span class="o">&amp;</span> <span class="n">player_position</span> <span class="o">=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dir_x</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dir_y</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">dir_len</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dir_x</span> <span class="o">*</span> <span class="n">dir_x</span> <span class="o">+</span> <span class="n">dir_y</span> <span class="o">*</span> <span class="n">dir_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dir_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">normalized_x</span> <span class="o">=</span> <span class="n">dir_x</span> <span class="o">/</span> <span class="n">dir_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">normalized_y</span> <span class="o">=</span> <span class="n">dir_y</span> <span class="o">/</span> <span class="n">dir_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">normalized_x</span> <span class="o">*</span> <span class="n">SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">normalized_y</span> <span class="o">*</span> <span class="n">SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">facing_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">facing_left</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2d碰撞检测的实现">2D碰撞检测的实现
</h4><p>这部分都放在敌人类中实现，玩家或者子弹的对象作为引用传入函数中，避免不必要的拷贝。</p>
<h5 id="敌人和子弹">敌人和子弹
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">CheckBulletCollision</span><span class="p">(</span><span class="k">const</span> <span class="n">Bullet</span><span class="o">&amp;</span> <span class="n">bullet</span><span class="p">)</span> <span class="c1">// 在参数前添加const：这个参数在函数中不会被修改
</span></span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将子弹等效为一个点，判断该点是否在敌人的矩形内
</span></span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_overlap_x</span> <span class="o">=</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">is_overlap_y</span> <span class="o">=</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">is_overlap_x</span> <span class="o">&amp;&amp;</span> <span class="n">is_overlap_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="敌人和玩家">敌人和玩家
</h5><p>在游戏的碰撞检测中，一般不会太严格。如果将敌人和玩家均作为一个矩形去检测碰撞，可能会发生两者只有一个角落重叠但是从视觉上看并未发生碰撞的情况，让玩家困惑。所以一般情况下，受击碰撞器都会小于图片尺寸。此处采用将敌人中心作为一个碰撞点来处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">CheckPlayerCollision</span><span class="p">(</span><span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 将敌人的中心点位置视为敌人的碰撞点
</span></span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">check_position</span> <span class="o">=</span> <span class="p">{</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_overlap_x</span> <span class="o">=</span> <span class="n">check_position</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">check_position</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">x</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_overlap_y</span> <span class="o">=</span> <span class="n">check_position</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">check_position</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">y</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">is_overlap_x</span> <span class="o">&amp;&amp;</span> <span class="n">is_overlap_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="子弹的更新和视觉效果的提升">子弹的更新和视觉效果的提升
</h4><p>因为围绕玩家的子弹是由一圈3颗子弹组成的，所以将其作为全局函数处理。</p>
<p>关于子弹的运动，可以通过随着时间的推移改变α的值来表示，为了计算方便，此处的角度单位均为弧度：</p>
<img src="teyvat2.png" alt="" style="zoom:33%;" />
<p>相应的代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 更新子弹位置
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UpdateBullets</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Bullet</span><span class="o">&gt;&amp;</span> <span class="n">bullet_list</span><span class="p">,</span> <span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 让子弹有一个不断收缩的效果，视觉上更加炫酷
</span></span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">double</span> <span class="n">RADIAL_SPEED</span> <span class="o">=</span> <span class="mf">0.0045</span><span class="p">;</span> <span class="c1">// 径向波动速度
</span></span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">double</span> <span class="n">TANGENT_SPEED</span> <span class="o">=</span> <span class="mf">0.0055</span><span class="p">;</span> <span class="c1">// 切向波动速度
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">radian_interval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">bullet_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="c1">// 三颗子弹间的弧度间隔
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 根据玩家的位置，依次更新每颗子弹的位置
</span></span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">player_position</span> <span class="o">=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">BULLET_BASE_RADIUS</span> <span class="o">+</span> <span class="n">BULLET_RADIUS_CHANGE_RANGE</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">GetTickCount</span><span class="p">()</span> <span class="o">*</span> <span class="n">RADIAL_SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bullet_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">radian</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">*</span> <span class="n">TANGENT_SPEED</span> <span class="o">+</span> <span class="n">radian_interval</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">bullet_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">radian</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">bullet_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">radian</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="删除被击杀的敌人">删除被击杀的敌人
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 依次检查敌人列表，移除被击杀的敌人
</span></span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">enemy_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">// 因为此处会动容器本身，所以不能用迭代器遍历
</span></span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Enemy</span><span class="o">*</span> <span class="n">enemy</span> <span class="o">=</span> <span class="n">enemy_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enemy</span><span class="o">-&gt;</span><span class="n">CheckAlive</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 和容器最后一个元素交换后，移除最后一个
</span></span></span><span class="line"><span class="cl">		<span class="c1">// * 是元素顺序无关紧要时，性能较好的一种删除方法
</span></span></span><span class="line"><span class="cl">		<span class="n">swap</span><span class="p">(</span><span class="n">enemy_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">enemy_list</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="n">enemy_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">enemy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="播放音效">播放音效
</h4><p>此项目使用Windows的库函数实现播放音效。可以写成这样的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 打开项目文件夹mus下的bgm.mp3文件，并且以后就叫它“bgm”
</span></span></span><span class="line"><span class="cl"><span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;open mus/bgm.mp3 alias bgm&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	<span class="c1">// 加载音效
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 播放别名叫bgm的音效，并从开头处循环播放
</span></span></span><span class="line"><span class="cl"><span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;play bgm repeat from 0&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>		<span class="c1">// 如果不需要循环，就不要加repeat	
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="提升性能使用享元模式优化资源加载">提升性能：使用享元模式优化资源加载
</h4><p>游戏中的模型和贴图资源所占比例很高，对硬盘空间和游戏启动时间的消耗都很大。享元模式在游戏开发中非常常用。比如，游戏中的一棵树的资源，一般的写法和使用享元模式的写法对比：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//========= 一般写法 =========
</span></span></span><span class="line"><span class="cl"><span class="c1">// 树的结构体
</span></span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Tree</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Model</span> <span class="n">model</span><span class="p">;</span>	<span class="c1">// 树的模型
</span></span></span><span class="line"><span class="cl">    <span class="n">Texture</span> <span class="n">texture</span><span class="p">;</span><span class="c1">// 树的贴图
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>	<span class="c1">// 树的位置
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//======= 享元模式写法 =======
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 树的资产结构体
</span></span></span><span class="line"><span class="cl"><span class="c1">// 无论树有多少棵，均使用同一个TreeAsset对象中的数据
</span></span></span><span class="line"><span class="cl"><span class="c1">// 这也是绘制一棵树所需数据中最庞大的那部分
</span></span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">TreeAsset</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Model</span> <span class="n">model</span><span class="p">;</span>	<span class="c1">// 树的模型
</span></span></span><span class="line"><span class="cl">    <span class="n">Texture</span> <span class="n">texture</span><span class="p">;</span><span class="c1">// 树的贴图
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 树结构体
</span></span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Tree</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TreeAsset</span><span class="o">*</span> <span class="n">asset</span><span class="p">;</span>	<span class="c1">// 树的资产的指针
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>		<span class="c1">// 树的位置
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在此项目中，对Animation类进行重新拆分和设计，提取游戏中每一个个体敌人可以共享的数据 <code>std::vector&lt;IMAGE*&gt; frame_list</code> ，而其他三个私有成员，则是状态信息，是每一个敌人独有的。</p>
<p>每个个体持有共享数据的图集类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 资源加载优化
</span></span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Atlas</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Atlas</span><span class="p">(</span><span class="n">LPCTSTR</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 加载图片
</span></span></span><span class="line"><span class="cl">		<span class="n">TCHAR</span> <span class="n">path_file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_stprintf_s</span><span class="p">(</span><span class="n">path_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">IMAGE</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IMAGE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">loadimage</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">path_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">frame_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Atlas</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">delete</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">vector</span><span class="o">&lt;</span><span class="n">IMAGE</span><span class="o">*&gt;</span> <span class="n">frame_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每个个体独有的数据封装在Animation类中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Animation</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="p">(</span><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_atlas</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">interval_ms</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Animation</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span> <span class="c1">// atlas是Animation类对象共享的公共资产，所以不能在Animation的析构函数中使用delete释放atlas指针
</span></span></span><span class="line"><span class="cl">							<span class="c1">// 需要在更上一层释放（main）
</span></span></span><span class="line"><span class="cl">							<span class="c1">// 况且这里也没有new
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 播放动画
</span></span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Play</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">timer</span> <span class="o">+=</span> <span class="n">delta_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&gt;=</span> <span class="n">interval_ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">idx_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">anim_atlas</span><span class="o">-&gt;</span><span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">putimage_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">anim_atlas</span><span class="o">-&gt;</span><span class="n">frame_list</span><span class="p">[</span><span class="n">idx_frame</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">interval_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 帧间隔
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画计时器
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">idx_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画帧索引
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Atlas</span><span class="o">*</span> <span class="n">anim_atlas</span><span class="p">;</span> <span class="c1">// 需要持有Atlas类的指针
</span></span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="按钮类的设计">按钮类的设计
</h4><p>按钮的状态有三种：Idle、Hover和Pushed，理清这三者的跳转关系来编写玩家输入的代码：</p>
<img src="teyvat3.webp" alt="" style="zoom:60%;" />
<p>相应的，我们需要处理的情况也有三种：鼠标移动、左键按下、左键抬起：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ProcessEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">ExMessage</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">WM_MOUSEMOVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span> <span class="o">&amp;&amp;</span> <span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Hovered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Hovered</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">WM_LBUTTONDOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Pushed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">WM_LBUTTONUP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Pushed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">OnClick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="番外篇角色动画特效和像素缓冲区">番外篇：角色动画特效和像素缓冲区
</h2><h3 id="色彩知识补充">色彩知识补充
</h3><p>图片的最小单位是像素，像素的色彩由三原色红、绿、蓝（Red Green Blue），也就是我们常说的“RGB”，经过不同强度的各原色混合得到。如果用一个Color的结构体，可以这样表示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Color</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>“图片”本质上就是由这些像素所构成的二维数组。一张像素为 <code>100*100</code> 的图片可以等价为 <code>Color image[100][100];</code> 那么在窗口中绘制一张图片的过程就是将这个小一点的二维数组拷贝到窗口这个大一点的二维数组的过程。而绘制的坐标则决定了像素数组位置的索引EasyX的 <code>IMAGE</code> 类中，有一个 <code>DWORD* m_pBuffer;</code> 的指针，用来指向存储图片像素色彩的缓冲区地址。由因为二维数组在内存中的存储其实是按照从左到右、从上到下的方式连续存储的，所以如果我们想要访问 <code>(x, y)</code> 位置的像素颜色的值，用二维数组表示的代码是 <code>Color pix_color = image[y][x]</code> ，在EasyX中需要转化为 <code>DWORD pix_color = buffer[y * width + x]</code> （width为图片宽度）。而这个指向像素缓冲区的指针，则可以由EasyX提供的接口 <code>DWORD* GetImageBuffer(IMAGE* PImg = NULL)</code> 获取。所以，如果要获得 <code>image</code> 这张图片的色彩缓冲区，可以这样写 <code>DWORD* buffer = GetImageBuffer(&amp;image)</code>，缓冲区中的每一个 <code>DWORD </code>类型的元素都占据四个字节，存储RGBA（RGB色彩元素和透明通道）的信息。</p>
<h3 id="图像翻转效果的实现">图像翻转效果的实现
</h3><p>首先加载原始的图片素材，此例中为玩家向左的动画图片。然后定义玩家角色向右的动画序列帧数组，遍历每一张向左的图片并进行翻转。需要注意的是，首先我们需要使用了 <code>Resize</code> 来向右的序列帧图片调整为相同的大小，因为定义的<code>IMAGE</code> 对象如果没有使用其他对象进行拷贝构造或者使用 <code>loadimage</code> 函数进行加载的话，内部的像素缓存区默认是不存在的，所以 <code>Resize</code> 的过程同时也是对 <code>IMAGE</code> 对象进行内存分配的过程。接着，我们获取向左的图片和向右的图片的像素缓冲区，遍历图片像素缓冲区中的每一个像素，将它从向左的图片中拷贝到向右的图片中对应的位置上。那么在x轴上的元素在翻转后的位置索引为 <code>width - 1 - x</code>。具体的实现是这样的：</p>
<p>加载向左的动画帧图片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img_player_left</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 加载玩家向左的动画
</span></span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">TCHAR</span> <span class="n">img_path</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">_stprintf_s</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/paimon_left_&amp;d.png&#34;</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实现向右翻转的动画帧图片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img_player_right</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Resize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_right</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>	<span class="c1">// 调整向右动画图片尺寸，同时为向右的图片开辟内存空间
</span></span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历两套图片的色彩缓冲区，逐行进行水平翻转
</span></span></span><span class="line"><span class="cl">    <span class="c1">// 并将相应索引上的像素信息拷贝给向右图片，完成翻转
</span></span></span><span class="line"><span class="cl">    <span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_left_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_right_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_right</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">idx_left_img</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>					<span class="c1">// 源像素索引（向左图片）
</span></span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">idx_right_img</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">);</span>	<span class="c1">// 目标像素索引（向右图片）
</span></span></span><span class="line"><span class="cl">            <span class="n">color_buffer_right_img</span><span class="p">[</span><span class="n">idx_right_img</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_buffer_left_img</span><span class="p">[</span><span class="n">idx_left_img</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="获取每一个像素颜色的rgb分量">获取每一个像素颜色的RGB分量
</h3><p>EasyX提供了 <code>GetGValue</code> <code>GetRValue</code> 和<code>GetBValue</code> 这三个宏来分别获取分量值。但需要特别注意的是，常用的COLORREF（一种表示颜色的类型，本质上是32位的整数）在内存中的表示形式为 <code>0xbbggrr</code> ，里面的红色和蓝色是对调的，所以我们在用EasyX的三个宏获取RGB分量时要需要调换R和B的位置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">pix_color</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">x</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="n">r</span> <span class="o">=</span> <span class="n">GetBValue</span><span class="p">(</span><span class="n">pix_color</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="n">g</span> <span class="o">=</span> <span class="n">GetGValue</span><span class="p">(</span><span class="n">pix_color</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BYTE</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GetRValue</span><span class="p">(</span><span class="n">pix_color</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="图片闪烁效果的实现">图片闪烁效果的实现
</h3><p>本质上就是切换图片正常状态的序列帧和其纯白色的剪影序列帧即可。剪影序列帧也是可以通过操作渲染缓冲区进行动态生成。那么如何将像素的颜色设置为纯白色呢？首先可以使用RGB宏组合出COLORREF类型的值，然后使用BGR交换红色和蓝色的顺序，最后设置其透明通道的值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 前半部分获得标准顺序RGB的白色：0x00FFFFFF
</span></span></span><span class="line"><span class="cl"><span class="c1">// 后半部分构造alpha通道（透明度）：(BYTE)(255)是8位的255，代表完全不透明，向左位移24位，得到0xFF000000
</span></span></span><span class="line"><span class="cl"><span class="c1">// 前后部分用按位或进行合并，得到0xFFFFFFFF，即完全不透明的纯白色
</span></span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">white_pix</span> <span class="o">=</span> <span class="n">BGR</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">BYTE</span><span class="p">)(</span><span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么实现图片闪烁的具体思路就是：先定义一个剪影序列帧的图片数组，然后同样遍历每一张原始图片素材，使用 <code>Resize</code> 将它们设置为相同大小并开辟内存空间。然后分别获取它们的色彩缓冲区，在两层循环中先判断当前位置的颜色是否为白色，如果不是则设置为白色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="n">img_player_left_sketch</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 生成玩家向左动画的剪影
</span></span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调整剪影动画图片尺寸大小同时开辟内存
</span></span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Resize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left_sketch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取两套图片的色彩缓冲区
</span></span></span><span class="line"><span class="cl">    <span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_raw_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_sketch_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_player_left_sketch</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历图片的色彩缓冲区，将透明度不为0的像素设置为白色
</span></span></span><span class="line"><span class="cl">   	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">((</span><span class="n">color_buffer_raw_img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>	<span class="c1">// if的判断条件为真，即像素不为0（白色）
</span></span></span><span class="line"><span class="cl">                <span class="n">color_buffer_sketch_img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BGR</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">BYTE</span><span class="p">)(</span><span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="冻结效果的实现">冻结效果的实现
</h3><h4 id="alpha混合的原理">Alpha混合的原理
</h4><p>EasyX在绘制图片是不考虑透明度的，那么透明度存在时的色彩计算公式为 <code>最终颜色 = 源颜色 * Alpha + 目标颜色 * （1 - Alpha）</code> 此处的Alpha值不是0 - 255，而是0 - 1的浮点数。 也就是说，如果将一张纯绿色的图片绘制到一张纯红色背景图片上时，覆盖位置的颜色可以进行这样的计算：</p>
<figure style="text-align: center;">
  <img src="teyvat4.webp" alt="不考虑Alpha混合图片叠加效果" style="zoom:33%;" />
  <figcaption style="font-size: 0.9em; color: #A0AEC0;">不考虑 Alpha 混合的图片叠加效果</figcaption>
</figure>
<figure style="text-align: center;">
  <img src="teyvat5.webp" alt="考虑Alpha混合图片叠加效果" style="zoom:33%;" />
  <figcaption style="font-size: 0.9em; color: #A0AEC0;">考虑 Alpha 混合的图片叠加效果及其计算公式</figcaption>
</figure>
<p>所以冰冻效果的实现思路，可以将一张冰冻的图片，以半透明的方式贴附在正常显示的图片之上。</p>
<h4 id="具体实现">具体实现
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 拷贝当前帧用于后续处理
</span></span></span><span class="line"><span class="cl"><span class="n">IMAGE</span> <span class="nf">img_current_frame</span><span class="p">(</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_curent_frame</span><span class="p">.</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img_curent_frame</span><span class="p">.</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 获取当前帧图片和冰冻图片的色彩缓冲区
</span></span></span><span class="line"><span class="cl"><span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_ice_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_ice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_frame_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_current_frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 遍历当前帧的色彩缓冲区，将不透明的区域进行混叠
</span></span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">RATIO</span> <span class="o">=</span> <span class="mf">0.25f</span><span class="p">;</span>	<span class="c1">// 混叠比例
</span></span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">color_ice_img</span> <span class="o">=</span> <span class="n">color_buffer_ice_img</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">color_frame_img</span> <span class="o">=</span> <span class="n">color_buffer_frame_img</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">color_frame_img</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>	<span class="c1">// 0xFF000000为透明通道
</span></span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 注意：色彩缓冲区中颜色存储的顺序是BGR，所以获取时需要调换B和R的位置
</span></span></span><span class="line"><span class="cl">            <span class="n">BYTE</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetBValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetBValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">BYTE</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetGValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetGValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">BYTE</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetRValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetRValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 与透明通道叠加
</span></span></span><span class="line"><span class="cl">            <span class="n">color_buffer_frame_img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">BGR</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">BYTE</span><span class="p">)(</span><span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="优化给冰冻状态增加高亮效果">优化：给冰冻状态增加高亮效果
</h4><p>思路：用一条白色扫描线从上至下扫描图片，为了让效果更逼真，我们对混叠后的贴图先进行亮度提取，只有亮度大于一定阈值的部分才会显示为白色条带，所以调整后的完整代码是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">RenderFrozenPlayer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="n">POINT</span> <span class="n">position</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1075</span><span class="p">,</span> <span class="mi">345</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="c1">// 动画帧索引
</span></span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">anim_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">// 动画计时器
</span></span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">frozen_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// 冰冻状态计时器
</span></span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">THICKNESS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="c1">// 扫描线宽度
</span></span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">hightlight_pos_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// 扫描线竖直坐标
</span></span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">bool</span> <span class="n">is_frozen</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="c1">// 当前是否正在冰冻
</span></span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果没有处于冰冻状态则更新动画计时器
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_frozen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">anim_timer</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新冻结计时器并重置扫描线位置
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">frozen_timer</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">is_frozen</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_frozen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">highlight_pos_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">THICKNESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 绘制玩家脚底阴影
</span></span></span><span class="line"><span class="cl">    <span class="n">putimage_alpha</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_shadow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据当前是否处于冰冻状态渲染不同的动画帧
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_frozen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拷贝当前帧用于后续处理
</span></span></span><span class="line"><span class="cl">        <span class="n">IMAGE</span> <span class="n">img_current_frame</span><span class="p">(</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img_curent_frame</span><span class="p">.</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img_curent_frame</span><span class="p">.</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新高亮扫描线竖直坐标
</span></span></span><span class="line"><span class="cl">        <span class="n">highlight_pos_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">highlight_pos_y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取当前帧图片和冰冻图片的色彩缓冲区
</span></span></span><span class="line"><span class="cl">		<span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_ice_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_ice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span><span class="o">*</span> <span class="n">color_buffer_frame_img</span> <span class="o">=</span> <span class="n">GetImageBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_current_frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">RATIO</span> <span class="o">=</span> <span class="mf">0.25f</span><span class="p">;</span>		<span class="c1">// 混叠比例
</span></span></span><span class="line"><span class="cl">                <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="mf">0.84f</span><span class="p">;</span>	<span class="c1">// 高亮阈值
</span></span></span><span class="line"><span class="cl">                <span class="n">DWORD</span> <span class="n">color_ice_img</span> <span class="o">=</span> <span class="n">color_buffer_ice_img</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">DWORD</span> <span class="n">color_frame_img</span> <span class="o">=</span> <span class="n">color_buffer_frame_img</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="n">color_frame_img</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>	<span class="c1">// 0xFF000000为透明通道
</span></span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 注意：色彩缓冲区中颜色存储的顺序是BGR，所以获取时需要调换B和R的位置
</span></span></span><span class="line"><span class="cl">                    <span class="n">BYTE</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetBValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                                    <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetBValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BYTE</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetGValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                                    <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetGValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="n">BYTE</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="p">)(</span><span class="n">GetRValue</span><span class="p">(</span><span class="n">color_frame_img</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                                    <span class="o">*</span> <span class="n">RATIO</span> <span class="o">+</span> <span class="n">GetRValue</span><span class="p">(</span><span class="n">color_ice_img</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">RATIO</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// 如果高亮扫描线处的像素亮度大于阈值，则直接将该像素设置为白色
</span></span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">hightlight_pos_y</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="o">=</span> <span class="n">highlight_pos_y</span> <span class="o">+</span> <span class="n">THICKNESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">r</span> <span class="o">/</span> <span class="mf">255.0f</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2126f</span> <span class="o">+</span> <span class="p">(</span><span class="n">g</span> <span class="o">/</span> <span class="mf">255.0f</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7152f</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="mf">255.0f</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0722f</span> 
</span></span><span class="line"><span class="cl">                           <span class="o">&gt;=</span> <span class="n">TRESHOLD</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    	<span class="n">color_buffer_frame_img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">                            <span class="o">=</span> <span class="p">(</span><span class="n">BGR</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">BYTE</span><span class="p">)(</span><span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color_buffer_frame_img</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">BGR</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="o">|</span> <span class="p">(((</span><span class="n">DWORD</span><span class="p">)(</span><span class="n">BYTE</span><span class="p">)(</span><span class="mi">255</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">putimage_alpha</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_current_frame</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">putimage_alpha</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_player_left</span><span class="p">[</span><span class="n">counter</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于RGB色彩分量的亮度计算时，每个颜色前的系数来自于经验公式。</p>
<h2 id="项目主体部分的完整源码">项目主体部分的完整源码
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;graphics.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* =============== 知识点 ===============
</span></span></span><span class="line"><span class="cl"><span class="cm">* 1.主循环内应尽量避免阻塞式行为或者过于繁重且耗时过长的任务
</span></span></span><span class="line"><span class="cl"><span class="cm">* 2.用计数器和用计时器来控制动画的帧更新的区别：
</span></span></span><span class="line"><span class="cl"><span class="cm">*	计数器：会存在电脑的刷新速度越快，帧更新就越快的情况
</span></span></span><span class="line"><span class="cl"><span class="cm">*	计时器：不管什么电脑，帧更新都和实际的时间流逝一致
</span></span></span><span class="line"><span class="cl"><span class="cm">* 3.利用享元模式对资源加载进行优化
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">WINDOW_WIDTH</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">WINDOW_HEIGHT</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">FPS</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">double</span> <span class="n">PI</span> <span class="o">=</span> <span class="mf">3.14159</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BULLET_BASE_RADIUS</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BULLET_RADIUS_CHANGE_RANGE</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">PLAYER_ANIM_NUM</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">ENEMY_ANIM_NUM</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BUTTON_WIDTH</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">int</span> <span class="n">BUTTON_HEIGHT</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">is_game_started</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">is_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#pragma comment(lib, &#34;MSIMG32.LIB&#34;) </span><span class="c1">// pragma comment作用：链接库
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma comment(lib, &#34;Winmm.lib&#34;) </span><span class="c1">// 音频播放的库
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 自己定义一个可以处理透明度的图片绘制函数
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">putimage_alpha</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">IMAGE</span><span class="o">*</span> <span class="n">img</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 资源加载优化
</span></span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Atlas</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Atlas</span><span class="p">(</span><span class="n">LPCTSTR</span> <span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 加载图片
</span></span></span><span class="line"><span class="cl">		<span class="n">TCHAR</span> <span class="n">path_file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">_stprintf_s</span><span class="p">(</span><span class="n">path_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">IMAGE</span><span class="o">*</span> <span class="n">frame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IMAGE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">loadimage</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">path_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">frame_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Atlas</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">delete</span> <span class="n">frame_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">vector</span><span class="o">&lt;</span><span class="n">IMAGE</span><span class="o">*&gt;</span> <span class="n">frame_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas_player_left</span><span class="p">;</span> <span class="c1">// 放在main中初始化
</span></span></span><span class="line"><span class="cl"><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas_player_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas_enemy_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas_enemy_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Animation</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="p">(</span><span class="n">Atlas</span><span class="o">*</span> <span class="n">atlas</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_atlas</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">interval_ms</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Animation</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span> <span class="c1">// atlas是Animation类对象共享的公共资产，所以不能在Animation的析构函数中使用delete释放atlas指针
</span></span></span><span class="line"><span class="cl">							<span class="c1">// 需要在更上一层释放（main）
</span></span></span><span class="line"><span class="cl">							<span class="c1">// 况且这里也没有new
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 播放动画
</span></span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Play</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">timer</span> <span class="o">+=</span> <span class="n">delta_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&gt;=</span> <span class="n">interval_ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">idx_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">anim_atlas</span><span class="o">-&gt;</span><span class="n">frame_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">putimage_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">anim_atlas</span><span class="o">-&gt;</span><span class="n">frame_list</span><span class="p">[</span><span class="n">idx_frame</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">interval_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 帧间隔
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画计时器
</span></span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">idx_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画帧索引
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Atlas</span><span class="o">*</span> <span class="n">anim_atlas</span><span class="p">;</span> <span class="c1">// 需要持有Atlas类的指针
</span></span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Player</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Player</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_shadow</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/shadow_player.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animation</span><span class="p">(</span><span class="n">atlas_player_left</span><span class="p">,</span> <span class="mi">45</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animation</span><span class="p">(</span><span class="n">atlas_player_right</span><span class="p">,</span> <span class="mi">45</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Player</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">anim_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">anim_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">ProcessEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">ExMessage</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_KEYDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">vkcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_up</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_DOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_down</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_LEFT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_left</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_RIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_right</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_KEYUP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">vkcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_DOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_down</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_LEFT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">VK_RIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">is_moving_right</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>		
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Move</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_moving_up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_moving_down</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_moving_left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_moving_right</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">SPEED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 解决斜线移动速度更快的问题
</span></span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">dir_x</span> <span class="o">=</span> <span class="n">is_moving_right</span> <span class="o">-</span> <span class="n">is_moving_left</span><span class="p">;</span> <span class="c1">// 向右为x轴正方向
</span></span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">dir_y</span> <span class="o">=</span> <span class="n">is_moving_down</span> <span class="o">-</span> <span class="n">is_moving_up</span><span class="p">;</span> <span class="c1">// 向下为y轴正方向
</span></span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">len_dir</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dir_x</span> <span class="o">*</span> <span class="n">dir_x</span> <span class="o">+</span> <span class="n">dir_y</span> <span class="o">*</span> <span class="n">dir_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">len_dir</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">double</span> <span class="n">normalized_x</span> <span class="o">=</span> <span class="n">dir_x</span> <span class="o">/</span> <span class="n">len_dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="kt">double</span> <span class="n">normalized_y</span> <span class="o">=</span> <span class="n">dir_y</span> <span class="o">/</span> <span class="n">len_dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">SPEED</span> <span class="o">*</span> <span class="n">normalized_x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">SPEED</span> <span class="o">*</span> <span class="n">normalized_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 限制玩家移动范围
</span></span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">FRAME_WIDTH</span> <span class="o">&gt;</span> <span class="n">WINDOW_WIDTH</span><span class="p">)</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">WINDOW_WIDTH</span> <span class="o">-</span> <span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span> <span class="o">&gt;</span> <span class="n">WINDOW_HEIGHT</span><span class="p">)</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">WINDOW_HEIGHT</span> <span class="o">-</span> <span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Draw</span><span class="p">(</span><span class="kt">int</span> <span class="n">delta_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 在绘制玩家之前绘制阴影
</span></span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">shadow_pos_x</span> <span class="o">=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">SHADOW_WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">shadow_pos_y</span> <span class="o">=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">putimage_alpha</span><span class="p">(</span><span class="n">shadow_pos_x</span><span class="p">,</span> <span class="n">shadow_pos_y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_shadow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">static</span> <span class="kt">bool</span> <span class="n">facing_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">dir_x</span> <span class="o">=</span> <span class="n">is_moving_right</span> <span class="o">-</span> <span class="n">is_moving_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">facing_left</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">facing_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">facing_left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">anim_left</span><span class="o">-&gt;</span><span class="n">Play</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">anim_right</span><span class="o">-&gt;</span><span class="n">Play</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">POINT</span><span class="o">&amp;</span> <span class="n">GetPosition</span><span class="p">()</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">FRAME_WIDTH</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">FRAME_HEIGHT</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">SPEED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// player移动的速度
</span></span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">SHADOW_WIDTH</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>	
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_shadow</span><span class="p">;</span> <span class="c1">// 玩家脚下阴影
</span></span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="o">*</span> <span class="n">anim_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="o">*</span> <span class="n">anim_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">position</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">500</span> <span class="p">};</span> <span class="c1">// 玩家坐标
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 解决消息处理和按键异步造成的玩家移动卡顿问题
</span></span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_moving_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_moving_down</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_moving_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">is_moving_right</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Bullet</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Bullet</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Bullet</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Draw</span><span class="p">()</span> <span class="k">const</span> <span class="c1">// 在成员方法后面加上const：这个方法不会修改类的成员变量
</span></span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">setlinecolor</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">setfillcolor</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">fillcircle</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">RADIUS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">position</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">RADIUS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Enemy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Enemy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_shadow</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/shadow_enemy.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animation</span><span class="p">(</span><span class="n">atlas_enemy_left</span><span class="p">,</span> <span class="mi">45</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">anim_right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animation</span><span class="p">(</span><span class="n">atlas_enemy_right</span><span class="p">,</span> <span class="mi">45</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 敌人生成的边界
</span></span></span><span class="line"><span class="cl">		<span class="k">enum</span> <span class="k">class</span> <span class="nc">SpawnEdge</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Down</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Left</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Right</span>
</span></span><span class="line"><span class="cl">		<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 将敌人生成在四条边界中随机的一条上
</span></span></span><span class="line"><span class="cl">		<span class="n">SpawnEdge</span> <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">SpawnEdge</span><span class="p">)(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 具体的随机坐标值
</span></span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">(</span><span class="n">edge</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Up</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Down</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Left</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">SpawnEdge</span><span class="o">::</span><span class="nl">Right</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">WINDOW_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rand</span> <span class="p">()</span> <span class="o">%</span> <span class="n">WINDOW_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Enemy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">anim_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">anim_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="nf">CheckBulletCollision</span><span class="p">(</span><span class="k">const</span> <span class="n">Bullet</span><span class="o">&amp;</span> <span class="n">bullet</span><span class="p">)</span> <span class="c1">// 在参数前添加const：这个参数在函数中不会被修改
</span></span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 将子弹等效为一个点，判断该点是否在敌人的矩形内
</span></span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">is_overlap_x</span> <span class="o">=</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">is_overlap_y</span> <span class="o">=</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">bullet</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">is_overlap_x</span> <span class="o">&amp;&amp;</span> <span class="n">is_overlap_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="nf">CheckPlayerCollision</span><span class="p">(</span><span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 将敌人的中心点位置视为敌人的碰撞点
</span></span></span><span class="line"><span class="cl">		<span class="n">POINT</span> <span class="n">check_position</span> <span class="o">=</span> <span class="p">{</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">is_overlap_x</span> <span class="o">=</span> <span class="n">check_position</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">check_position</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">x</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">is_overlap_y</span> <span class="o">=</span> <span class="n">check_position</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">check_position</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">().</span><span class="n">y</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">is_overlap_x</span> <span class="o">&amp;&amp;</span> <span class="n">is_overlap_y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Move</span><span class="p">(</span><span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">POINT</span><span class="o">&amp;</span> <span class="n">player_position</span> <span class="o">=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">dir_x</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">dir_y</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">dir_len</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dir_x</span> <span class="o">*</span> <span class="n">dir_x</span> <span class="o">+</span> <span class="n">dir_y</span> <span class="o">*</span> <span class="n">dir_y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">dir_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">double</span> <span class="n">normalized_x</span> <span class="o">=</span> <span class="n">dir_x</span> <span class="o">/</span> <span class="n">dir_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="kt">double</span> <span class="n">normalized_y</span> <span class="o">=</span> <span class="n">dir_y</span> <span class="o">/</span> <span class="n">dir_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">normalized_x</span> <span class="o">*</span> <span class="n">SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">normalized_y</span> <span class="o">*</span> <span class="n">SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">facing_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dir_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">facing_left</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Draw</span><span class="p">(</span><span class="kt">int</span> <span class="n">delta_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">shadow_pos_x</span> <span class="o">=</span> <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">SHADOW_WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">shadow_pos_y</span> <span class="o">=</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">FRAME_HEIGHT</span> <span class="o">-</span> <span class="mi">35</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">putimage_alpha</span><span class="p">(</span><span class="n">shadow_pos_x</span><span class="p">,</span> <span class="n">shadow_pos_y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_shadow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">facing_left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">anim_left</span><span class="o">-&gt;</span><span class="n">Play</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">anim_right</span><span class="o">-&gt;</span><span class="n">Play</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Hurt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">alive</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="nf">CheckAlive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">alive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">SPEED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">FRAME_WIDTH</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">FRAME_HEIGHT</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">SHADOW_WIDTH</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_shadow</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="o">*</span> <span class="n">anim_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Animation</span><span class="o">*</span> <span class="n">anim_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">position</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span> 
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">facing_left</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">alive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Button的基类
</span></span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Button</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Button</span><span class="p">(</span><span class="n">RECT</span> <span class="n">rect</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_idle</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_hovered</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_pushed</span><span class="p">)</span> <span class="c1">// 加载图片
</span></span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">region</span> <span class="o">=</span> <span class="n">rect</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_idle</span><span class="p">,</span> <span class="n">path_imag_idle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_hovered</span><span class="p">,</span> <span class="n">path_imag_hovered</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_pushed</span><span class="p">,</span> <span class="n">path_imag_pushed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">Button</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">Draw</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">Status</span><span class="o">::</span><span class="nl">Idle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">putimage</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_idle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">Status</span><span class="o">::</span><span class="nl">Hovered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">putimage</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_hovered</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">Status</span><span class="o">::</span><span class="nl">Pushed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">putimage</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_pushed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">ProcessEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">ExMessage</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">WM_MOUSEMOVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span> <span class="o">&amp;&amp;</span> <span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Hovered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Hovered</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">WM_LBUTTONDOWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">CheckCursorHit</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Pushed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">WM_LBUTTONUP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">::</span><span class="n">Pushed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">OnClick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">virtual</span> <span class="kt">void</span> <span class="n">OnClick</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CheckCursorHit</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">bottom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="k">class</span> <span class="nc">Status</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Hovered</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Pushed</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">RECT</span> <span class="n">region</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_hovered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_pushed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 开始游戏按钮
</span></span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">StartGameButton</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Button</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">StartGameButton</span><span class="p">(</span><span class="n">RECT</span> <span class="n">rect</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_idle</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_hovered</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_pushed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="n">Button</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">path_imag_idle</span><span class="p">,</span> <span class="n">path_imag_hovered</span><span class="p">,</span> <span class="n">path_imag_pushed</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">StartGameButton</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">OnClick</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">is_game_started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;play bgm repeat from 0&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// 重复播放bgm
</span></span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 退出游戏按钮
</span></span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QuitGameButton</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Button</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">QuitGameButton</span><span class="p">(</span><span class="n">RECT</span> <span class="n">rect</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_idle</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_hovered</span><span class="p">,</span> <span class="n">LPCTSTR</span> <span class="n">path_imag_pushed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="n">Button</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">path_imag_idle</span><span class="p">,</span> <span class="n">path_imag_hovered</span><span class="p">,</span> <span class="n">path_imag_pushed</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="o">~</span><span class="n">QuitGameButton</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">OnClick</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">is_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TryGenerateEnemy</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Enemy</span><span class="o">*&gt;&amp;</span> <span class="n">enemy_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UpdateBullets</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Bullet</span><span class="o">&gt;&amp;</span> <span class="n">bullet_list</span><span class="p">,</span> <span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DrawPlayerScore</span><span class="p">(</span><span class="kt">int</span> <span class="n">score</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">initgraph</span><span class="p">(</span><span class="n">WINDOW_WIDTH</span><span class="p">,</span> <span class="n">WINDOW_HEIGHT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;open mus/bgm.mp3 alias bgm&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// 加载
</span></span></span><span class="line"><span class="cl">	<span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;open mus/hit.wav alias hit&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// player和enemy的构造函数都要用到atlas，所以atlas的初始化必须放在这两者之前
</span></span></span><span class="line"><span class="cl">	<span class="n">atlas_player_left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atlas</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/player_left_%d.png&#34;</span><span class="p">),</span> <span class="n">PLAYER_ANIM_NUM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">atlas_player_right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atlas</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/player_right_%d.png&#34;</span><span class="p">),</span> <span class="n">PLAYER_ANIM_NUM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">atlas_enemy_left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atlas</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/enemy_left_%d.png&#34;</span><span class="p">),</span> <span class="n">ENEMY_ANIM_NUM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">atlas_enemy_right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Atlas</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/enemy_right_%d.png&#34;</span><span class="p">),</span> <span class="n">ENEMY_ANIM_NUM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Player</span> <span class="n">player</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Enemy</span><span class="o">*&gt;</span> <span class="n">enemy_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">vector</span><span class="o">&lt;</span><span class="n">Bullet</span><span class="o">&gt;</span> <span class="n">bullet_list</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">// 子弹只有三颗，所以不使用指针的形式，避免内存泄漏的风险	
</span></span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">ExMessage</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_menu</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">	<span class="n">IMAGE</span> <span class="n">img_background</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">RECT</span> <span class="n">region_btn_start_game</span><span class="p">,</span> <span class="n">region_btn_quit_game</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ================ UI ================
</span></span></span><span class="line"><span class="cl">	<span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">WINDOW_WIDTH</span> <span class="o">-</span> <span class="n">BUTTON_WIDTH</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">BUTTON_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">430</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">region_btn_start_game</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">BUTTON_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">WINDOW_WIDTH</span> <span class="o">-</span> <span class="n">BUTTON_WIDTH</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">BUTTON_WIDTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">550</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">region_btn_quit_game</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">BUTTON_HEIGHT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">StartGameButton</span> <span class="n">btn_start_game</span> <span class="o">=</span> <span class="n">StartGameButton</span><span class="p">(</span><span class="n">region_btn_start_game</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_start_idle.png&#34;</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_start_hovered.png&#34;</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_start_pushed.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">QuitGameButton</span> <span class="n">btn_quit_game</span> <span class="o">=</span> <span class="n">QuitGameButton</span><span class="p">(</span><span class="n">region_btn_quit_game</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_quit_idle.png&#34;</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_quit_hovered.png&#34;</span><span class="p">),</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/ui_quit_pushed.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_menu</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/menu.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">loadimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">img_background</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;img/background.png&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">BeginBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">is_running</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="n">peekmessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">is_game_started</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">player</span><span class="p">.</span><span class="n">ProcessEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">btn_start_game</span><span class="p">.</span><span class="n">ProcessEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">btn_quit_game</span><span class="p">.</span><span class="n">ProcessEvent</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_game_started</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">player</span><span class="p">.</span><span class="n">Move</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">UpdateBullets</span><span class="p">(</span><span class="n">bullet_list</span><span class="p">,</span> <span class="n">player</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">TryGenerateEnemy</span><span class="p">(</span><span class="n">enemy_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">Enemy</span><span class="o">*</span> <span class="nl">enemy</span> <span class="p">:</span> <span class="n">enemy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">enemy</span><span class="o">-&gt;</span><span class="n">Move</span><span class="p">(</span><span class="n">player</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 检测敌人与玩家的碰撞
</span></span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">Enemy</span><span class="o">*</span> <span class="nl">enemy</span> <span class="p">:</span> <span class="n">enemy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">enemy</span><span class="o">-&gt;</span><span class="n">CheckPlayerCollision</span><span class="p">(</span><span class="n">player</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">static</span> <span class="n">TCHAR</span> <span class="n">text</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">					<span class="n">_stprintf_s</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;最终得分：%d！&#34;</span><span class="p">),</span> <span class="n">score</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">MessageBox</span><span class="p">(</span><span class="n">GetHWnd</span><span class="p">(),</span> <span class="n">text</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;游戏结束&#34;</span><span class="p">),</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">is_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 检测敌人与子弹的碰撞
</span></span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">Enemy</span><span class="o">*</span> <span class="nl">enemy</span> <span class="p">:</span> <span class="n">enemy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">Bullet</span><span class="o">&amp;</span> <span class="nl">bullet</span> <span class="p">:</span> <span class="n">bullet_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="p">(</span><span class="n">enemy</span><span class="o">-&gt;</span><span class="n">CheckBulletCollision</span><span class="p">(</span><span class="n">bullet</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">mciSendString</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&#34;play hit from 0&#34;</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">						<span class="n">enemy</span><span class="o">-&gt;</span><span class="n">Hurt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">						<span class="n">score</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// 依次检查敌人列表，移除被击杀的敌人
</span></span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">enemy_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">// 因为此处会动容器本身，所以不能用迭代器遍历
</span></span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">Enemy</span><span class="o">*</span> <span class="n">enemy</span> <span class="o">=</span> <span class="n">enemy_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enemy</span><span class="o">-&gt;</span><span class="n">CheckAlive</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// 和容器最后一个元素交换后，移除最后一个
</span></span></span><span class="line"><span class="cl">					<span class="c1">// * 是元素顺序无关紧要时，性能较好的一种删除方法
</span></span></span><span class="line"><span class="cl">					<span class="n">swap</span><span class="p">(</span><span class="n">enemy_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">enemy_list</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">					<span class="n">enemy_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">					<span class="k">delete</span> <span class="n">enemy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">cleardevice</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ======= Draw  =======
</span></span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">is_game_started</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">putimage</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_background</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">player</span><span class="p">.</span><span class="n">Draw</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">Enemy</span><span class="o">*</span> <span class="nl">enemy</span> <span class="p">:</span> <span class="n">enemy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">enemy</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">Bullet</span><span class="o">&amp;</span> <span class="nl">bullet</span> <span class="p">:</span> <span class="n">bullet_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">bullet</span><span class="p">.</span><span class="n">Draw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">DrawPlayerScore</span><span class="p">(</span><span class="n">score</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">putimage</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">img_menu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">btn_start_game</span><span class="p">.</span><span class="n">Draw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">btn_quit_game</span><span class="p">.</span><span class="n">Draw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">FlushBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">delta_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">delta_time</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">FPS</span> <span class="o">-</span> <span class="n">delta_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// atlas指针需在游戏主循环结束后释放
</span></span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">atlas_player_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">atlas_player_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">atlas_enemy_left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">atlas_enemy_right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">EndBatchDraw</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">putimage_alpha</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">IMAGE</span><span class="o">*</span> <span class="n">img</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">getwidth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">getheight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">AlphaBlend</span><span class="p">(</span><span class="n">GetImageHDC</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">GetImageHDC</span><span class="p">(</span><span class="n">img</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">{</span> <span class="n">AC_SRC_OVER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">AC_SRC_ALPHA</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TryGenerateEnemy</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Enemy</span><span class="o">*&gt;&amp;</span> <span class="n">enemy_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">INTERVAL</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">counter</span> <span class="o">%</span> <span class="n">INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">enemy_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">new</span> <span class="n">Enemy</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 更新子弹位置
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UpdateBullets</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Bullet</span><span class="o">&gt;&amp;</span> <span class="n">bullet_list</span><span class="p">,</span> <span class="k">const</span> <span class="n">Player</span><span class="o">&amp;</span> <span class="n">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 让子弹有一个不断收缩的效果，视觉上更加炫酷
</span></span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">double</span> <span class="n">RADIAL_SPEED</span> <span class="o">=</span> <span class="mf">0.0045</span><span class="p">;</span> <span class="c1">// 径向波动速度
</span></span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">double</span> <span class="n">TANGENT_SPEED</span> <span class="o">=</span> <span class="mf">0.0055</span><span class="p">;</span> <span class="c1">// 切向波动速度
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">radian_interval</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">bullet_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="c1">// 三颗子弹间的弧度间隔
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 根据玩家的位置，依次更新每颗子弹的位置
</span></span></span><span class="line"><span class="cl">	<span class="n">POINT</span> <span class="n">player_position</span> <span class="o">=</span> <span class="n">player</span><span class="p">.</span><span class="n">GetPosition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">BULLET_BASE_RADIUS</span> <span class="o">+</span> <span class="n">BULLET_RADIUS_CHANGE_RANGE</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">GetTickCount</span><span class="p">()</span> <span class="o">*</span> <span class="n">RADIAL_SPEED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bullet_list</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">radian</span> <span class="o">=</span> <span class="n">GetTickCount</span><span class="p">()</span> <span class="o">*</span> <span class="n">TANGENT_SPEED</span> <span class="o">+</span> <span class="n">radian_interval</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">bullet_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_WIDTH</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">radian</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">bullet_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">player_position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">player</span><span class="p">.</span><span class="n">FRAME_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">radian</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DrawPlayerScore</span><span class="p">(</span><span class="kt">int</span> <span class="n">score</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="n">TCHAR</span> <span class="n">text</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">_stprintf_s</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">_T</span><span class="p">(</span><span class="s">&#34;当前玩家得分：%d&#34;</span><span class="p">),</span> <span class="n">score</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">setbkmode</span><span class="p">(</span><span class="n">TRANSPARENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">settextcolor</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">185</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">outtextxy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="复盘和总结">复盘和总结
</h2><p>虽然这个项目的实现还是基于初学者的直觉进行开发，并未做太多架构上的设计，但是我还是学到了很多。老师同样是从游戏的框架开始，渐渐细化每个模块，同时他清晰展示了每一部分遇到了怎样的问题，可以用怎样的思路解决问题，对我自己的开发具有很大的参考价值。同时还让我详细了解了动画的底层实现，补充了颜色和像素的知识，帮我复习了向量运动和2D碰撞。以一个非常浅显又实操的例子让我明白了享元模式和设计模式的作用。经常会有一种醍醐灌顶、拨开云雾见青天的感觉。接下来需要进一步补充的地方，一是关于3D的碰撞检测等，3D的内容在学校里以非常传统的读教科书做题的方式学过一遍，但是没有开发中的例子所以印象不深，感觉现在已经全忘了。二是游戏开发的设计模式，在读书的时候也是按照最传统的方式看书回答问题，但那时的感觉基本是看天书一般，蒙着做的题目，所以应该会继续学习这位老师相关的设计模式课程，让自己在实战中有更深刻的理解。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/game-dev/">Game Dev</a>
        
            <a href="/tags/c&#43;&#43;/">C&#43;&#43;</a>
        
            <a href="/tags/easyx/">EasyX</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-copyright">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-clock">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 Oct 16, 2025 11:10 &#43;0200
        </span>
    </section></footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%A4%8D%E7%89%A9%E6%98%8E%E6%98%9F%E5%A4%A7%E4%B9%B1%E6%96%97%E4%B9%8Bgameplay%E5%B1%82%E5%AE%9E%E7%8E%B0/">
        
        
            <div class="article-image">
                <img src="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%A4%8D%E7%89%A9%E6%98%8E%E6%98%9F%E5%A4%A7%E4%B9%B1%E6%96%97%E4%B9%8Bgameplay%E5%B1%82%E5%AE%9E%E7%8E%B0/cover.1b012a76c5604bf796bf2aca3a991558_hu_ff7b20efb25024f9.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 【从零开始的C&#43;&#43;游戏开发】植物明星大乱斗之Gameplay层实现"
                        
                        data-hash="md5-GwEqdsVgS/eWvyrKOpkVWA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">【从零开始的C&#43;&#43;游戏开发】植物明星大乱斗之Gameplay层实现</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%A4%8D%E7%89%A9%E6%98%8E%E6%98%9F%E5%A4%A7%E4%B9%B1%E6%96%97%E4%B9%8B%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1/">
        
        
            <div class="article-image">
                <img src="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E6%A4%8D%E7%89%A9%E6%98%8E%E6%98%9F%E5%A4%A7%E4%B9%B1%E6%96%97%E4%B9%8B%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1/cover.ec0863682fef9b7bb25dd0aa71367140_hu_5306f28b8aa9e474.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 【从零开始的C&#43;&#43;游戏开发】植物明星大乱斗之框架设计"
                        
                        data-hash="md5-7AhjaC/vm3uyXdCqcTZxQA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">【从零开始的C&#43;&#43;游戏开发】植物明星大乱斗之框架设计</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/">
        
        
            <div class="article-image">
                <img src="/p/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84c-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/cover.a2ea06cd2ac9a81a050fadd3f675c4b2_hu_3bbe836a0980eab5.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 【从零开始的C&#43;&#43;游戏开发】基础"
                        
                        data-hash="md5-ouoGzSrJqBoFD63T9nXEsg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">【从零开始的C&#43;&#43;游戏开发】基础</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E7%BB%83%E6%89%8B%E6%97%A5%E5%BF%97unity%E5%B0%8F%E6%B8%B8%E6%88%8F%E9%9B%86%E9%94%A6-2/">
        
        
            <div class="article-image">
                <img src="/p/%E7%BB%83%E6%89%8B%E6%97%A5%E5%BF%97unity%E5%B0%8F%E6%B8%B8%E6%88%8F%E9%9B%86%E9%94%A6-2/cover.e234c6f5d3ed6725521421ec36928286_hu_f1d3211ccc597964.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 【练手日志】Unity小游戏集锦 2"
                        
                        data-hash="md5-4jTG9dPtZyVSFCHsNpKChg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">【练手日志】Unity小游戏集锦 2</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/solidsolid%E5%8E%9F%E5%88%99%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5/">
        
        
            <div class="article-image">
                <img src="/p/solidsolid%E5%8E%9F%E5%88%99%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5/cover.692841708aeddf19659467c6f14cb721_hu_82e846adb3b35da9.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 【SOLID】SOLID原则项目实践"
                        
                        data-hash="md5-aShBcIrt3xlllGfG8Uy3IQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">【SOLID】SOLID原则项目实践</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
       
    <section class="totalcount">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        发表了13篇文章 ·
        总计8万2千字
        <br>
    </section>


    
    <section class="running-time">
        本博客已运行
        <span id="runningdays" class="running-days"></span>
    </section>

    <section class="copyright">
        &copy;
        
        2025 -
        
        2026 Nullshow
    </section>

    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener"
                data-version="3.31.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>

</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script><script type="text/javascript" src="/ts/custom.711fbb0ee2e4cf3223d76423fbe2fc4e019ec898fb854a9d7bea4eb3169278df.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script>
(() => {
    
    if (window.__L2D_WIDGET_INITED__) return;
    window.__L2D_WIDGET_INITED__ = true;

    const cdnPath = "https://cdn.jsdelivr.net/gh/letere-gzj/live2d-widget-v3@main";
    const config = {
        path: {
            homePath: "/",
            modelPath: "https://cdn.jsdelivr.net/gh/NullshowJL/hugo-static-resources@3aa0848/",
            cssPath: '\/waifu\/waifu.css',
            tipsJsonPath: '\/waifu\/waifu-tips.json',
            tipsJsPath: cdnPath + "/waifu-tips.js",
            live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
            live2dSdkPath: cdnPath + "/live2d-sdk.js"
        },
        tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
        drag: { enable: true, direction: ["x", "y"] },
        switchType: "order"
    };

    if (screen.width >= 768) {
        Promise.all([
            loadExternalResource(config.path.cssPath, "css"),
            loadExternalResource(config.path.live2dCorePath, "js"),
            loadExternalResource(config.path.live2dSdkPath, "js"),
            loadExternalResource(config.path.tipsJsPath, "js")
        ]).then(() => {
            initWidget({
                waifuPath: config.path.tipsJsonPath,
                cdnPath: config.path.modelPath,
                tools: config.tools,
                dragEnable: config.drag.enable,
                dragDirection: config.drag.direction,
                switchType: config.switchType
            });
        });
    }

    function loadExternalResource(url, type) {
        return new Promise((resolve, reject) => {
            let tag;
            if (type === "css") {
                tag = document.createElement("link");
                tag.rel = "stylesheet";
                tag.href = url;
            } else if (type === "js") {
                tag = document.createElement("script");
                tag.src = url;
            }
            if (tag) {
                tag.onload = () => resolve(url);
                tag.onerror = () => reject(url);
                document.head.appendChild(tag);
            }
        });
    }
})();
</script>

<style>
     
    #waifu #waifu-tool,
    #waifu .waifu-tool,
    #waifu .waifu-toolbar,
    #waifu .waifu-tools {
        transform: translateY(-50px);
        z-index: 1001;  
    }
</style>


<style>
    @font-face {
        font-family: 'WenKai';
        src: url(https://nullshowjl.github.io/font/WenKai.ttf) format('truetype');
    }

    @font-face {
        font-family: 'Mate';
        src: url(https://nullshowjl.github.io/font/Mate.ttf) format('truetype');
    }

    @font-face {
        font-family: 'SourceCodePro';
        src: url(https://nullshowjl.github.io/font/SourceCodePro.ttf) format('truetype');
    }

    :root {
        --base-font-family: 'Mate', 'WenKai', sans-serif;
        --code-font-family: 'SourceCodePro';
    }

    body {
        font-family: 'Mate', 'WenKai', sans-serif;
        font-display: swap;
    }

    code,
    pre {
        font-family: var(--code-font-family), monospace;
        white-space: pre;
         
        tab-size: 4;
         
    }
</style>


<style>
  #TableOfContents > ul ul,
  #TableOfContents > ul ol,
  #TableOfContents > ol ul,
  #TableOfContents > ol ol { display: none; }
  #TableOfContents .open { display: block; }
</style>

<script>
    function initTocHide() {
        const toc = document.querySelector(".widget--toc");
        if (!toc) return;

        window.addEventListener("scroll", () => {
            document.querySelectorAll(".open").forEach((ul) => ul.classList.remove("open"));

            const currentLi = document.querySelector(".active-class");
            if (!currentLi) return;

            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open");
            }

            let ul = currentLi.parentElement;
            while (ul && (ul.localName === "ul" || ul.localName === "ol")) {
                ul.classList.add("open");
                ul = ul.parentElement?.parentElement;
            }
        });
    }

    initTocHide();
</script>


<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        right: left: 60%;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url('https://nullshowjl.github.io/icons/backTop.svg');
        background-size: cover;
    }
</style>

<script>
    function initScrollTop() {
        const rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) return;

        const btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop;
        rightSideBar.appendChild(btn);

        window.onscroll = () => {
            const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            btn.style.display = scrollTop > 20 ? "block" : "none";
        };
    }

    function backToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    initScrollTop();
</script>


<style>
    .highlight {
        max-height: 400px;
        overflow: hidden;
        position: relative;
    }

    .code-show {
        max-height: none !important;
        overflow: visible !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }
</style>

<script>
  function initCodeMoreBox() {
    const codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) return;

    codeBlocks.forEach((codeBlock) => {
      if (codeBlock.querySelector(".code-more-box")) return;
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) return;

      const codeMoreBox = document.createElement("div");
      codeMoreBox.classList.add("code-more-box");

      const codeMoreBtn = document.createElement("span");
      codeMoreBtn.classList.add("code-more-btn");

      const img = document.createElement("img");
      img.classList.add("code-more-img");
      img.src = 'https:\/\/nullshowjl.github.io\/icons\/codeMore.png';

      codeMoreBtn.appendChild(img);
      codeMoreBtn.addEventListener("click", () => {
        codeBlock.classList.add("code-show");
        codeMoreBox.remove();
        window.dispatchEvent(new Event("resize"));
      });

      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox);
    });
  }

  initCodeMoreBox();
</script>


<script defer src="https://cn.vercount.one/js"></script>

<script>
    function showHideView() {
        const viewCounts = document.querySelectorAll("#viewCount");
        if (!viewCounts.length) return;

        const article = document.querySelector(".article-page");
        if (!article) {
            viewCounts.forEach((ele) => {
                ele.style.display = "none";
            });
        }
    }

    showHideView();
</script>





<div id="particles-js"></div>

<script src="https://nullshowjl.github.io/background/particles.min.js"></script>
<script>
  particlesJS.load('particles-js', 'https:\/\/nullshowjl.github.io\/background\/particlesjs-config.json', function () {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
    #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
</style>


<div id="jsi-flying-fish-container" class="flying-fish-container"></div>

<script src="/js/renderer.js"></script>
<script>
    window.onload = () => {
        if (typeof RENDERER !== 'undefined') {
            RENDERER.init();
        }
    };
</script>


<script>
    (() => {
        const start = new Date('2025-09-14'); 
        const now = new Date();

        let years = now.getFullYear() - start.getFullYear();
        let months = now.getMonth() - start.getMonth();
        let days = now.getDate() - start.getDate();

        if (days < 0) {
            months -= 1;
            const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
            days += prevMonth.getDate();
        }

        if (months < 0) {
            years -= 1;
            months += 12;
        }

        const result = `${years}年${months}月${days}天`;
        const runningEl = document.getElementById('runningdays');
        if (runningEl) {
            runningEl.textContent = result;
        }
    })();
</script>


        
<script>
(() => {
    
    if (window.__L2D_WIDGET_INITED__) return;
    window.__L2D_WIDGET_INITED__ = true;

    const cdnPath = "https://cdn.jsdelivr.net/gh/letere-gzj/live2d-widget-v3@main";
    const config = {
        path: {
            homePath: "/",
            modelPath: "https://cdn.jsdelivr.net/gh/NullshowJL/hugo-static-resources@3aa0848/",
            cssPath: '\/waifu\/waifu.css',
            tipsJsonPath: '\/waifu\/waifu-tips.json',
            tipsJsPath: cdnPath + "/waifu-tips.js",
            live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
            live2dSdkPath: cdnPath + "/live2d-sdk.js"
        },
        tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "photo", "info", "quit"],
        drag: { enable: true, direction: ["x", "y"] },
        switchType: "order"
    };

    if (screen.width >= 768) {
        Promise.all([
            loadExternalResource(config.path.cssPath, "css"),
            loadExternalResource(config.path.live2dCorePath, "js"),
            loadExternalResource(config.path.live2dSdkPath, "js"),
            loadExternalResource(config.path.tipsJsPath, "js")
        ]).then(() => {
            initWidget({
                waifuPath: config.path.tipsJsonPath,
                cdnPath: config.path.modelPath,
                tools: config.tools,
                dragEnable: config.drag.enable,
                dragDirection: config.drag.direction,
                switchType: config.switchType
            });
        });
    }

    function loadExternalResource(url, type) {
        return new Promise((resolve, reject) => {
            let tag;
            if (type === "css") {
                tag = document.createElement("link");
                tag.rel = "stylesheet";
                tag.href = url;
            } else if (type === "js") {
                tag = document.createElement("script");
                tag.src = url;
            }
            if (tag) {
                tag.onload = () => resolve(url);
                tag.onerror = () => reject(url);
                document.head.appendChild(tag);
            }
        });
    }
})();
</script>

<style>
     
    #waifu #waifu-tool,
    #waifu .waifu-tool,
    #waifu .waifu-toolbar,
    #waifu .waifu-tools {
        transform: translateY(-50px);
        z-index: 1001;  
    }
</style>


<style>
    @font-face {
        font-family: 'WenKai';
        src: url(https://nullshowjl.github.io/font/WenKai.ttf) format('truetype');
    }

    @font-face {
        font-family: 'Mate';
        src: url(https://nullshowjl.github.io/font/Mate.ttf) format('truetype');
    }

    @font-face {
        font-family: 'SourceCodePro';
        src: url(https://nullshowjl.github.io/font/SourceCodePro.ttf) format('truetype');
    }

    :root {
        --base-font-family: 'Mate', 'WenKai', sans-serif;
        --code-font-family: 'SourceCodePro';
    }

    body {
        font-family: 'Mate', 'WenKai', sans-serif;
        font-display: swap;
    }

    code,
    pre {
        font-family: var(--code-font-family), monospace;
        white-space: pre;
         
        tab-size: 4;
         
    }
</style>


<style>
  #TableOfContents > ul ul,
  #TableOfContents > ul ol,
  #TableOfContents > ol ul,
  #TableOfContents > ol ol { display: none; }
  #TableOfContents .open { display: block; }
</style>

<script>
    function initTocHide() {
        const toc = document.querySelector(".widget--toc");
        if (!toc) return;

        window.addEventListener("scroll", () => {
            document.querySelectorAll(".open").forEach((ul) => ul.classList.remove("open"));

            const currentLi = document.querySelector(".active-class");
            if (!currentLi) return;

            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open");
            }

            let ul = currentLi.parentElement;
            while (ul && (ul.localName === "ul" || ul.localName === "ol")) {
                ul.classList.add("open");
                ul = ul.parentElement?.parentElement;
            }
        });
    }

    initTocHide();
</script>


<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        right: left: 60%;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url('https://nullshowjl.github.io/icons/backTop.svg');
        background-size: cover;
    }
</style>

<script>
    function initScrollTop() {
        const rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) return;

        const btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop;
        rightSideBar.appendChild(btn);

        window.onscroll = () => {
            const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            btn.style.display = scrollTop > 20 ? "block" : "none";
        };
    }

    function backToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    initScrollTop();
</script>


<style>
    .highlight {
        max-height: 400px;
        overflow: hidden;
        position: relative;
    }

    .code-show {
        max-height: none !important;
        overflow: visible !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff);
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }
</style>

<script>
  function initCodeMoreBox() {
    const codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) return;

    codeBlocks.forEach((codeBlock) => {
      if (codeBlock.querySelector(".code-more-box")) return;
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) return;

      const codeMoreBox = document.createElement("div");
      codeMoreBox.classList.add("code-more-box");

      const codeMoreBtn = document.createElement("span");
      codeMoreBtn.classList.add("code-more-btn");

      const img = document.createElement("img");
      img.classList.add("code-more-img");
      img.src = 'https:\/\/nullshowjl.github.io\/icons\/codeMore.png';

      codeMoreBtn.appendChild(img);
      codeMoreBtn.addEventListener("click", () => {
        codeBlock.classList.add("code-show");
        codeMoreBox.remove();
        window.dispatchEvent(new Event("resize"));
      });

      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox);
    });
  }

  initCodeMoreBox();
</script>


<script defer src="https://cn.vercount.one/js"></script>

<script>
    function showHideView() {
        const viewCounts = document.querySelectorAll("#viewCount");
        if (!viewCounts.length) return;

        const article = document.querySelector(".article-page");
        if (!article) {
            viewCounts.forEach((ele) => {
                ele.style.display = "none";
            });
        }
    }

    showHideView();
</script>





<div id="particles-js"></div>

<script src="https://nullshowjl.github.io/background/particles.min.js"></script>
<script>
  particlesJS.load('particles-js', 'https:\/\/nullshowjl.github.io\/background\/particlesjs-config.json', function () {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
    #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }
</style>


<div id="jsi-flying-fish-container" class="flying-fish-container"></div>

<script src="/js/renderer.js"></script>
<script>
    window.onload = () => {
        if (typeof RENDERER !== 'undefined') {
            RENDERER.init();
        }
    };
</script>


<script>
    (() => {
        const start = new Date('2025-09-14'); 
        const now = new Date();

        let years = now.getFullYear() - start.getFullYear();
        let months = now.getMonth() - start.getMonth();
        let days = now.getDate() - start.getDate();

        if (days < 0) {
            months -= 1;
            const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
            days += prevMonth.getDate();
        }

        if (months < 0) {
            years -= 1;
            months += 12;
        }

        const result = `${years}年${months}月${days}天`;
        const runningEl = document.getElementById('runningdays');
        if (runningEl) {
            runningEl.textContent = result;
        }
    })();
</script>


    </body>
</html>


